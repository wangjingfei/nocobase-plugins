# NocoBase JSON响应解析插件使用手册

## 简介

NocoBase JSON响应解析插件是一个专为NocoBase工作流设计的插件，用于处理HTTP请求返回的JSON数据，并将其解析为结构化的变量，供工作流下游节点使用。

通过此插件，您可以轻松地从复杂的JSON响应中提取所需的特定数据，而无需编写代码。插件支持JSONPath表达式，使得从嵌套的JSON结构中提取数据变得简单高效。

## 安装

### 前提条件

- 已安装NocoBase（版本0.x或更高）
- 已安装并启用工作流插件

### 安装步骤

1. 进入NocoBase管理界面
2. 导航到"设置" > "插件管理"
3. 点击"添加插件"按钮
4. 输入插件包名：`@nocobase/plugin-json-response`
5. 点击"安装"按钮
6. 安装完成后，启用该插件

## 基本使用

### 在工作流中添加JSON响应处理节点

1. 创建或编辑一个工作流
2. 添加一个HTTP请求节点（或其他产生JSON数据的节点）
3. 在该节点之后，添加一个"JSON响应处理"节点
4. 配置JSON响应处理节点

### 节点配置说明

![节点配置界面](./docs/images/node-config.png)

- **响应数据**：指定上游节点中包含JSON数据的变量名。如果留空，默认使用`data`
- **解析模式**：
  - **JSONPath**：使用JSONPath表达式从JSON数据中提取特定值
  - **Direct**：直接使用原始JSON数据，不进行解析
- **路径表达式**：当选择JSONPath解析模式时，输入JSONPath表达式，例如`$.data.items[0].id`
- **输出字段**：解析后的数据将存储在此变量中，供下游节点使用。如果留空，默认使用`parsedResponse`
- **默认值**：当解析结果为空（undefined或null）时使用的默认值
- **忽略错误**：开启此选项后，即使解析过程出错，工作流也会继续执行

## JSONPath语法指南

JSONPath是一种用于从JSON文档中提取数据的查询语言，类似于XML的XPath。

### 基本语法

| 符号           | 描述                                             |
|--------------|------------------------------------------------|
| $            | 根对象                                           |
| @            | 当前对象                                         |
| .            | 子元素操作符                                     |
| ..           | 递归下降，深层扫描                               |
| *            | 通配符，匹配所有元素                             |
| []           | 下标操作符                                       |
| [,]          | 多个下标，如[0,1]表示第一个和第二个元素         |
| [start:end:step] | 数组切片操作                                     |
| ?()          | 过滤表达式                                       |

### 常用示例

假设有以下JSON数据：

```json
{
  "store": {
    "book": [
      {
        "category": "reference",
        "author": "Nigel Rees",
        "title": "Sayings of the Century",
        "price": 8.95
      },
      {
        "category": "fiction",
        "author": "Evelyn Waugh",
        "title": "Sword of Honour",
        "price": 12.99
      }
    ],
    "bicycle": {
      "color": "red",
      "price": 19.95
    }
  }
}
```

常用JSONPath表达式示例：

- `$.store.book[0].title` - 获取第一本书的标题
- `$.store.book[*].author` - 获取所有书的作者
- `$..author` - 获取文档中所有的作者
- `$.store.*` - 获取store下的所有内容
- `$.store..price` - 获取store中所有的价格
- `$..book[?(@.price<10)]` - 获取所有价格小于10的书
- `$..book[?(@.category=="fiction")]` - 获取所有类别为fiction的书

## 实际应用场景

### 场景一：API数据提取

1. 使用HTTP请求节点调用第三方API
2. 使用JSON响应处理节点提取API返回的特定数据
3. 在下游节点中使用提取的数据进行进一步处理

### 场景二：数据转换与映射

1. 从数据库或API获取JSON格式的数据
2. 使用JSON响应处理节点提取需要的字段
3. 将提取的数据转换为特定格式或映射到特定字段

### 场景三：条件判断

1. 获取JSON格式的配置或状态数据
2. 使用JSON响应处理节点提取状态标志或配置值
3. 基于提取的值进行条件判断，执行不同的工作流分支

## 故障排除

### 常见问题与解决方案

1. **问题**：返回"No response data provided"错误
   **解决方案**：检查上游节点是否正确传递了JSON数据，确保响应数据字段名称正确

2. **问题**：JSONPath表达式没有返回预期结果
   **解决方案**：
   - 检查JSON数据结构和JSONPath表达式是否匹配
   - 使用在线JSONPath测试工具验证表达式
   - 尝试先使用Direct模式查看完整JSON结构

3. **问题**：解析结果为undefined或null
   **解决方案**：
   - 检查JSONPath表达式
   - 设置默认值作为备选
   - 开启"忽略错误"选项以继续工作流执行

## 高级用法

### 处理嵌套的复杂JSON结构

对于复杂的嵌套JSON结构，可以：
1. 先使用Direct模式查看完整结构
2. 针对不同部分创建多个JSON响应处理节点
3. 使用JSONPath的递归下降操作符(..)深度查找特定内容

### 与其他节点协作

- **与条件节点配合**：根据解析结果决定工作流路径
- **与循环节点配合**：处理JSON数组中的每个元素
- **与数据操作节点配合**：将解析结果保存到数据库

## 版本历史

- **0.1.0** - 初始版本
  - 支持JSONPath和Direct解析模式
  - 支持错误处理和默认值
  - 支持变量输出配置

## 支持与反馈

如有使用问题或功能建议，请通过以下渠道联系我们：

- 在GitHub仓库提交Issue
- 通过NocoBase社区论坛反馈
- 发送邮件至support@example.com

---

感谢您使用NocoBase JSON响应解析插件！我们希望它能帮助您更高效地处理JSON数据。 